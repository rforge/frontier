# efficiencies of frontier models
efficiencies.frontier <- function( object, asInData = FALSE, ... ) {

   if( asInData ) {
      resid <- residuals( object, asInData = TRUE )
      fitted <- object$dataTable[ , 3 ] - resid
      sigmaSq <- coef( object )[ "sigmaSq" ]
      gamma <- coef( object )[ "gamma" ]
      lambda <- sqrt( gamma / ( 1 - gamma ) )
      if( object$ineffDecrease ) {
         dir <- 1
      } else {
         dir <- -1
      }
      if( object$modelType == 1 ) {
         if( object$timeEffect ) {
            eta <- coef( object )[ "time" ]
            etaStar <- exp( - eta * ( object$dataTable[ , 2 ] - object$nt ) )
         } else {
            eta <- 0
            etaStar <- rep( 1, object$nob ) 
         }
         if( object$nt == 1 ) {
            residStar <- resid
            tStar <- 1
         } else {
            residStar <- rep( NA, object$nob )
            tStar <- rep( NA, object$nob )
            for( i in 1:object$nob ) {
               residStar[ i ] <- sum( resid[ object$dataTable[ , 1 ] ==
                  object$dataTable[ i, 1 ] ] *
                  etaStar[ object$dataTable[ , 1 ] == object$dataTable[ i, 1 ] ] )
               tStar[ i ] <- sum( etaStar[ object$dataTable[ , 1 ] ==
                  object$dataTable[ i, 1 ] ]^2 )
            }
         }
         if( object$truncNorm ) {
            mu <- coef( object )[ "mu" ]
         } else {
            mu <- 0
         }
         muStar <- ( - dir * gamma * residStar + mu * ( 1 - gamma ) ) /
            ( 1 + ( tStar - 1 ) * gamma )
         sigmaStarSq <- sigmaSq * gamma * ( 1 - gamma ) /
            ( 1 + ( tStar - 1 ) * gamma )
         sigmaStar <- sqrt( sigmaStarSq )
         if( object$logDepVar ) {
            result <- ( pnorm( - dir * sigmaStar * etaStar + muStar / sigmaStar ) /
               pnorm( muStar / sigmaStar ) ) *
               exp( - dir * muStar * etaStar + 0.5 * sigmaStarSq * etaStar^2 )
         } else {
            fittedStar <- rep( NA, object$nob )
            tInd <- rep( NA, object$nob )
            for( i in 1:object$nob ) {
               fittedStar[ i ] <- sum( fitted[ object$dataTable[ , 1 ] ==
                  object$dataTable[ i, 1 ] ] )
               tInd[ i ] <- sum( object$dataTable[ , 1 ] ==
                  object$dataTable[ i, 1 ] )
            }
            result <- 1 - dir * etaStar * ( muStar + sigmaStar *
               exp( dnorm( muStar / sigmaStar, log = TRUE ) -
                  pnorm( muStar / sigmaStar, log = TRUE ) ) ) /
               ( fittedStar / tInd )
         }
     } else if( object$modelType == 2 ) {
         if( object$zIntercept ) {
            zDelta <- coef( object )[ "Z_(Intercept)" ]
         } else {
            zDelta <- 0
         }
         nz <- ncol( object$dataTable ) - 3 - object$nb
         if( nz > 0 ) {
            for( i in 1:nz ) {
               zDelta <- zDelta + object$dataTable[ ,
                     ncol( object$dataTable ) - nz + i ] *
                  coef( object )[ object$nb + object$zIntercept + 1 + i  ]
            }
         }
         sigmaBarSq <- gamma * ( 1 - gamma ) * sigmaSq
         sigmaBar <- sqrt( sigmaBarSq )
         muBar <- ( 1 - gamma ) * zDelta - dir * gamma * resid
         if( object$logDepVar ) {
            result <- ( pnorm( - dir * sigmaBar + muBar / sigmaBar ) /
                  pnorm( muBar / sigmaBar ) ) *
                  exp( - dir * muBar + 0.5 * sigmaBarSq )
         } else {
            result <- 1 - dir * ( muBar + sigmaBar *
               exp( dnorm( muBar / sigmaBar, log = TRUE ) -
                  pnorm( muBar / sigmaBar, log = TRUE ) ) ) /
               fitted
         }
      } else {
         stop( "internal error: unknow model type '",
            object$modelType, "'" )
      }

      if( object$ineffDecrease ) {
         result[ result > 1 ] <- 1
      } else {
         result[ result < 1 ] <- 1
      }
      names( result ) <- rownames( object$dataTable )
   } else {
      result <- object$effic
   }
   return( result )
}
